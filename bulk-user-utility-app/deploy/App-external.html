<!DOCTYPE html>
<html>
<head>
    <title>BulkUserUtilityApp</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CA.technicalservices.userutilities.ProjectModel",{extend:"Ext.data.TreeModel",fields:[{name:"Name",type:"string"},{name:"ObjectID",type:"int"},{name:"Path",type:"string"},{name:"_ref",type:"string"},{name:"Parent",type:"auto"},{name:"__permissionAdmin",type:"boolean",defaultValue:!1},{name:"__permissionEditor",type:"boolean",defaultValue:!1},{name:"__permissionViewer",type:"boolean",defaultValue:!1},{name:"__permissionNone",type:"boolean",defaultValue:!1},{name:"__teamMember",type:"boolean",defaultValue:!1}]});
                Ext.define("CA.technicalservices.userutilities.ProjectUtility",{singleton:!0,permissions:{__permissionAdmin:"Project Admin",__permissionEditor:"Editor",__permissionViewer:"Viewer",__permissionNoAccess:"No Access"},initialize:function(){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["ObjectID","Name","Parent","Workspace"],limit:1/0,context:{project:null},compact:!1,filters:[{property:"State",value:"Open"}],sorters:[{property:"ObjectID",direction:"ASC"}]}).load({callback:function(records,operation){operation.wasSuccessful()?(CA.technicalservices.userutilities.ProjectUtility.initializeRecords(records),deferred.resolve()):deferred.reject("Error loading project structure: "+operation.error.errors.join(","))},scope:this}),deferred},initializeRecords:function(records){var hash={},rootProjects=[];Ext.Array.each(records,function(r){hash[r.get("ObjectID")]=r.getData(),hash[r.get("ObjectID")].children=[]}),Ext.Object.each(hash,function(oid,projectData){projectData.__projectHierarchy=CA.technicalservices.userutilities.ProjectUtility._buildProjectHierarchy(oid,hash);var parentID=projectData.Parent&&projectData.Parent.ObjectID||null;if(parentID){var parentModel=hash[parentID];parentModel.children.push(projectData)}else rootProjects.push(projectData)}),CA.technicalservices.userutilities.ProjectUtility.projectHash=hash,CA.technicalservices.userutilities.ProjectUtility.rootProjects=rootProjects},getProjectTreeData:function(){var newRootProjects=JSON.parse(JSON.stringify(CA.technicalservices.userutilities.ProjectUtility.rootProjects));return newRootProjects},_buildProjectHierarchy:function(projectID,projectHash){var parent=projectHash[projectID].Parent&&projectHash[projectID].Parent.ObjectID||null,projectHierarchy=[projectID];if(parent)do projectHierarchy.unshift(parent),parent=projectHash[parent]&&projectHash[parent].Parent&&projectHash[parent].Parent.ObjectID||null;while(parent);return projectHierarchy},assignPermissions:function(userOid,permission,projectOids,forceDowngrade){var deferred=Ext.create("Deft.Deferred");forceDowngrade=forceDowngrade||!1;var rootProjectData=CA.technicalservices.userutilities.ProjectUtility.getRootProjectData(projectOids,CA.technicalservices.userutilities.ProjectUtility.projectHash);console.log("rootProjectData",rootProjectData);var promises=[],me=this;return Ext.Array.each(rootProjectData,function(rpd){promises.push(function(){return CA.technicalservices.userutilities.ProjectUtility._updatePermissionRootProject(userOid,rpd.rootProjectOID,rpd.excludedProjectOIDs,permission,forceDowngrade)})}),Deft.Chain.parallel(promises).then({success:function(results){deferred.resolve(results)}}),deferred.promise},_updatePermissionRootProject:function(userObjectID,rootProjectObjectID,excludedProjectIDs,permission,forceDowngrade){console.log("_updatePermissionRootProject",userObjectID,rootProjectObjectID,excludedProjectIDs,permission,forceDowngrade);var deferred=Ext.create("Deft.Deferred");return forceDowngrade=forceDowngrade||!1,Ext.isArray(excludedProjectIDs)&&(excludedProjectIDs=excludedProjectIDs.join(",")),Ext.Ajax.request({url:"/slm/webservice/v2.0/projectpermission/bulkupdate",method:"POST",params:{userOID:userObjectID,rootProjectOID:rootProjectObjectID,excludedRootProjectOIDs:excludedProjectIDs,permission:permission,forceDowngradePermissions:forceDowngrade},scope:this,success:function(response,options){console.log("success",response,options);var result=this._parseResult(response);result.user=userObjectID,deferred.resolve(result)},failure:function(response,options){console.log("failed",response,options);var result=this._parseResult(response);result.user=userObjectID,deferred.resolve(result)}}),deferred.promise},_parseResult:function(response,options){var responseText=response&&response.responseText,status=response.status,success=!1;if(200===status){var operationResult=Ext.JSON.decode(response.responseText);if(operationResult&&operationResult.OperationResult&&operationResult.OperationResult.Results){var results=operationResult.OperationResult.Results;results.length>0&&(responseText=results[0],"Disabled"===responseText?responseText="This functionality is disabled for your subscription.":success=!0)}}return console.log("responseTest",responseText),{success:success,message:responseText}},getRootProjectData:function(projects,projectHash){var data=[];return Ext.Array.each(projects,function(p){var po=projectHash[p];po.Parent&&Ext.Array.contains(projects,po.Parent.ObjectID)||data.push({rootProjectOID:po.ObjectID,excludedProjectOIDs:CA.technicalservices.userutilities.ProjectUtility.getExcludedProjects(po.children,projects)})}),data},getExcludedProjects:function(children,projects){var excludedProjects=[];return Ext.Array.each(children,function(c){Ext.Array.contains(projects,c.ObjectID)?excludedProjects=Ext.Array.merge(excludedProjects,CA.technicalservices.userutilities.ProjectUtility.getExcludedProjects(c.children,projects)):excludedProjects.push(c.ObjectID)}),excludedProjects},getPermission:function(permissionKey){return CA.technicalservices.userutilities.ProjectUtility.permissions[permissionKey]||CA.technicalservices.userutilities.ProjectUtility.permissions.__permissionNoAccess}});
                Ext.define("CA.technicalservices.userutilities.ProjectPickerDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.projectpickerdialog",height:400,width:400,layout:"fit",closable:!0,draggable:!0,autoShow:!0,config:{title:"Choose an Item",multiple:!0,storeConfig:{context:{project:null},sorters:[{property:"FormattedID",direction:"DESC"}]},columns:[{text:"ID",dataIndex:"ObjectID",renderer:_.identity},"Name"],selectionButtonText:"Done",gridConfig:{},selectedRef:void 0,selectedRecords:void 0,initialSelectedRecords:void 0,showRadioButtons:!0},constructor:function(config){this.mergeConfig(config),this.callParent([this.config])},selectionCache:[],initComponent:function(){this.callParent(arguments),this.addEvents("itemschosen"),this.addCls(["chooserDialog","chooser-dialog"])},destroy:function(){this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"doneButton",text:this.selectionButtonText,cls:"primary rly-small",scope:this,disabled:!0,userAction:"clicked done in dialog",handler:function(){this.fireEvent("itemschosen",this.getSelectedRecords()),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this.introText&&this.addDocked({xtype:"component",componentCls:"intro-panel",html:this.introText}),this.addDocked({xtype:"toolbar",itemId:"searchBar",dock:"top",border:!1,padding:"0 0 10px 0",items:this.getSearchBarItems()}),this.buildGrid(),this.selectionCache=this.getInitialSelectedRecords()||[]},getSelectedRecords:function(){return this.multiple?this.selectionCache:this.selectionCache[0]},getSearchBarItems:function(){return[{xtype:"triggerfield",cls:"rui-triggerfield chooser-search-terms",emptyText:"Search Keyword or ID",enableKeyEvents:!0,flex:1,itemId:"searchTerms",listeners:{keyup:function(textField,event){event.getKey()===Ext.EventObject.ENTER&&this._search()},afterrender:function(field){field.focus()},scope:this},triggerBaseCls:"icon-search chooser-search-icon"}]},getStoreFilters:function(){return[]},buildGrid:function(){this.grid&&this.grid.destroy(),Ext.create("Rally.data.wsapi.ProjectTreeStoreBuilder").build({models:["project"],autoLoad:!0,enableHierarchy:!0,filters:[{property:"Parent",value:""}]}).then({scope:this,success:function(store){var mode=this.multiple?"MULTI":"SINGLE",checkbox_model=Ext.create("Rally.ui.selection.CheckboxModel",{mode:mode,enableKeyNav:!1,allowDeselect:!0});this.grid=this.add({xtype:"rallytreegrid",treeColumnDataIndex:"Name",treeColumnHeader:"Name",viewConfig:{cls:"grid-view-bulk-edit"},enableRanking:!1,enableEditing:!1,enableBulkEdit:!1,shouldShowRowActionsColumn:!1,selModel:checkbox_model,_defaultTreeColumnRenderer:function(value,metaData,record,rowIdx,colIdx,store){return store=store.treeStore||store,Rally.ui.renderer.RendererFactory.getRenderTemplate(store.model.getField("Name")).apply(record.data)},columnCfgs:[],store:store}),this.mon(this.grid,{beforeselect:this._onGridSelect,beforedeselect:this._onGridDeselect,load:this._onGridLoad,scope:this}),this.add(this.grid),this._onGridReady()}})},_enableDoneButton:function(){this.down("#doneButton").setDisabled(!this.selectionCache.length)},_findRecordInSelectionCache:function(record){return _.findIndex(this.selectionCache,function(cachedRecord){return cachedRecord.get("_ref")===record.get("_ref")})},_onGridSelect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);index===-1&&(this.multiple||(this.selectionCache=[]),this.selectionCache.push(record)),this._enableDoneButton()},_onGridDeselect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);index!==-1&&this.selectionCache.splice(index,1),this._enableDoneButton()},_onGridReady:function(){return this.grid.rendered?this.grid.getStore().isLoading()?void this.mon(this.grid,"load",this._onGridReady,this,{single:!0}):(this._onGridLoad(),void this.center()):void this.mon(this.grid,"afterrender",this._onGridReady,this,{single:!0})},_onGridLoad:function(){var store=this.grid.store,records=[];_.each(this.selectionCache,function(record){var foundNode=store.getRootNode().findChild("_ref",record.get("_ref"),!0);foundNode&&records.push(foundNode)}),records.length&&this.grid.getSelectionModel().select(records)},_search:function(){var terms=this._getSearchTerms(),store=this.grid.getStore();terms?store.filter([Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"contains",value:terms})]):store.clearFilter()},_getSearchTerms:function(){var textBox=this.down("#searchTerms");return textBox&&textBox.getValue()}}),Ext.override(Rally.data.wsapi.ParentChildMapper,{constructor:function(){this.parentChildTypeMap={project:[{typePath:"project",collectionName:"Children",parentField:"Parent"}],hierarchicalrequirement:[{typePath:"defect",collectionName:"Defects",parentField:"Requirement"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"},{typePath:"hierarchicalrequirement",collectionName:"Children",parentField:"Parent"}],defect:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],defectsuite:[{typePath:"defect",collectionName:"Defects",parentField:"DefectSuites"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],testset:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"TestSets"}]}}}),Ext.define("Rally.data.wsapi.ProjectTreeStore",{requires:["Deft.promise.Deferred","Rally.data.ModelFactory","Rally.ui.grid.data.NodeInterface","Rally.data.ModelTypes","Rally.data.wsapi.ParentChildMapper"],extend:"Rally.data.wsapi.TreeStore",alias:"store.rallyprojectwsapitreestore",parentTypes:["project"],childLevelSorters:[{property:"Name",direction:"ASC"}],getParentFieldNamesByChildType:function(childType,parentType){var model=this.model;return _.transform(this.mapper.getParentFields(childType,parentType),function(acc,field){var typePath=field.typePath,fieldName=field.fieldName,hasFieldModel=model.hasField(fieldName);hasFieldModel&&acc.push(fieldName.replace(/\s+/g,""))},[],this)},filter:function(filters){this.fireEvent("beforefilter",this),this.filters.clear(),this.filters.addAll(filters),this._resetCurrentPage(),this.load()},clearFilter:function(suppressEvent){this._resetCurrentPage(),this.filters.clear(),this.filters.addAll(Ext.create("Rally.data.wsapi.Filter",{property:"Parent",value:""})),suppressEvent||this.load()}}),Ext.define("Rally.data.wsapi.ProjectTreeStoreBuilder",{extend:"Rally.data.wsapi.TreeStoreBuilder",build:function(config){return config=_.clone(config||{}),config.storeType="Rally.data.wsapi.ProjectTreeStore",this.loadModels(config).then({success:function(models){return models=_.values(models),this._buildStoreWithModels(models,config)},scope:this})}});
                Ext.define("CA.technicalservices.userutilities.ProjectGrid",{extend:"Ext.tree.Panel",cls:"rally-grid",padding:25,rootVisible:!1,columns:[],initComponent:function(){this.callParent()}});
                Ext.define("CA.technicalservices.userutilities.dialog.ProjectPermissions",{extend:"Rally.ui.dialog.Dialog",autoShow:!0,draggable:!0,width:800,height:400,closable:!0,items:[],beforeRender:function(){this.callParent(arguments);var me=this;this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"doneButton",text:this.goText,cls:"primary rly-small",userAction:"clicked apply in dialog",handler:function(){me.fireEvent("updated",me,me.selectedCache||{}),me.close(),me.destroy()},scope:this},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this.projectGrid=Ext.create("CA.technicalservices.userutilities.ProjectGrid",{workspace:null,height:300,columns:this._getColumnCfgs(),itemId:"project-grid",listeners:{cellclick:this.updateToggles,scope:this},store:this._createStore()}),this.add(this.projectGrid)},updateToggles:function(view,cell,cellIndex,record){var clickedDataIndex=view.panel.headerCt.getHeaderAtIndex(cellIndex).dataIndex,value=record.get(clickedDataIndex),oid=record.get("ObjectID");clickedDataIndex&&/__permission/.test(clickedDataIndex)&&(record.set("__permissionAdmin",!1),record.set("__permissionEditor",!1),record.set("__permissionViewer",!1),value?this.updateCache(clickedDataIndex,oid,!1):(record.set(clickedDataIndex,!0),this.updateCache(clickedDataIndex,oid,!0)),this.updateRecordChildrenPermissions(record,clickedDataIndex,!value),record.expand(!0)),"__teamMember"===clickedDataIndex&&(record.set("__teamMember",!value),this.updateRecordChildrenField(record,!value,"__teamMember"),this.updateCache(clickedDataIndex,oid,!value),record.expand(!0)),"__permissionNone"===clickedDataIndex&&(record.set("__permissionNone",!value),this.updateRecordChildrenField(record,!value,"__permissionNone"),this.updateCache(clickedDataIndex,oid,!value),record.expand(!0))},updateRecordChildrenField:function(record,value,fieldName){var children=record.childNodes||[];Ext.Array.each(children,function(child){child.set(fieldName,value),this.updateCache(fieldName,record.get("ObjectID"),value),this.updateRecordChildrenField(child,value)},this)},updateCache:function(fieldName,oid,booleanFlag){this.selectedCache||(this.selectedCache={}),Ext.Object.each(this.selectedCache,function(f,cache){var idx=_.indexOf(cache,oid);idx>=0&&cache.splice(idx,1)}),booleanFlag&&(this.selectedCache[fieldName]||(this.selectedCache[fieldName]=[]),this.selectedCache[fieldName].push(oid))},updateRecordChildrenPermissions:function(record,clickedDataIndex,value){var children=record.childNodes||[];Ext.Array.each(children,function(child){child.set("__permissionAdmin",!1),child.set("__permissionEditor",!1),child.set("__permissionViewer",!1),child.set(clickedDataIndex,value),this.updateCache(clickedDataIndex,child.get("ObjectID"),value),this.updateRecordChildrenPermissions(child,clickedDataIndex,value)},this)},_getColumnCfgs:function(){var permissionWidth=75,buttonHeight=20,me=this,columns=[{xtype:"treecolumn",text:"Project",menuDisabled:!0,dataIndex:"Name",flex:1}];return"assignPermissions"===this.type&&(columns=columns.concat([{text:"Viewer",dataIndex:"__permissionViewer",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}},{text:"Editor",dataIndex:"__permissionEditor",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}},{text:"Admin",dataIndex:"__permissionAdmin",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}}])),"teamMembership"===this.type&&(columns=columns.concat([{text:"Team Member",dataIndex:"__teamMember",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}}])),"removeAccess"===this.type&&(columns=columns.concat([{text:"Remove Access",dataIndex:"__permissionNone",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}}])),columns},_createStore:function(records){var root=CA.technicalservices.userutilities.ProjectUtility.getProjectTreeData();return Ext.create("Ext.data.TreeStore",{root:{children:root,expanded:!1},model:"CA.technicalservices.userutilities.ProjectModel"})},destroy:function(){this.projectGrid&&this.projectGrid.destroy(),this.callParent(arguments)}});
                Ext.define("CA.technicalservices.userutilities.dialog.AssignProjectPermissions",{extend:"CA.technicalservices.userutilities.dialog.ProjectPermissions",title:"Project Permissions",goText:"Assign",_getColumnCfgs:function(){return[{xtype:"treecolumn",text:"Project",menuDisabled:!0,dataIndex:"Name",flex:1},{text:"Viewer",dataIndex:"__permissionViewer",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}},{text:"Editor",dataIndex:"__permissionEditor",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}},{text:"Admin",dataIndex:"__permissionAdmin",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}}]}});
                Ext.define("CA.technicalservices.userutilities.dialog.RemovePermissions",{extend:"CA.technicalservices.userutilities.dialog.ProjectPermissions",title:"Remove Project Permissions",goText:"Remove",_getColumnCfgs:function(){return[{xtype:"treecolumn",text:"Project",menuDisabled:!0,dataIndex:"Name",flex:1},{text:"Remove Access",dataIndex:"__permissionNone",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}}]}});
                Ext.define("CA.technicalservices.userutilities.dialog.TeamMembership",{extend:"CA.technicalservices.userutilities.dialog.ProjectPermissions",title:"Assign Team Membership",goText:"Assign",_getColumnCfgs:function(){return[{xtype:"treecolumn",text:"Project",menuDisabled:!0,dataIndex:"Name",flex:1},{text:"Team Member",dataIndex:"__teamMember",align:"center",renderer:function(v,m,r){var tpl=Ext.create("Rally.ui.renderer.template.ToggleButtonTemplate");return tpl.apply(v)}}]}});
                Ext.define("CA.technicalservices.userutilities.ListFilterPanel",{extend:"Ext.panel.Panel",alias:"widget.listfilterpanel",cls:"inline-filter-panel",flex:1,header:!1,minHeight:46,padding:"8px 0 0 0",bodyPadding:"7px 5px 5px 5px",collapseDirection:"top",collapsible:!0,animCollapse:!1,stateful:!0,stateId:"listFilterPanel",constructor:function(config){this.mergeConfig(config),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),(!this.stateful||this.stateful&&!this._hasState())&&this.applyState({})},_hasState:function(){return!(!this.stateful||!this.stateId)&&!!Ext.state.Manager.get(this.stateId)},_addItems:function(state){state||(state={}),this.removeAll(),this.add({xtype:"rallybutton",cls:"inline-filter-panel-close icon-cross",height:18,userAction:"Close (X) filter panel clicked",listeners:{click:function(){this.collapse()},scope:this}});var users="";state.users&&state.users.length>0&&(users=state.users.join(",")),this.add({xtype:"textarea",itemId:"listBox",flex:1,width:"90%",emptyText:"Paste or type comma, space, tab or return delimited field values here...",labelAlign:"top",margin:"0 20 5 20",fieldLabel:"Filter UserNames:",height:100,autoScroll:!0,value:users}),this.add({xtype:"container",layout:"hbox",items:[{xtype:"rallybutton",text:"Apply",margin:"5 5 20 20",listeners:{click:this.updateListItems,scope:this}},{xtype:"rallybutton",text:"Clear",margin:"5 5 20 5",listeners:{click:this.clearListItems,scope:this}}]})},clear:function(){this._getListBox().setValue("")},_getListBox:function(){return this.down("#listBox")},getState:function(){var currentState=this.getListItems();return currentState.listItems&&Ext.isArray(currentState.listItems)&&(currentState.listItems=currentState.listItems.join(",")),currentState},applyState:function(state){state&&state.listItems&&!Ext.isArray(state.listItems)&&(state.listItems=state.listItems.split(",")),this._addItems(state)},getListItems:function(){var listItems=this._getListBox().getValue();return listItems&&0!==listItems.length?(listItems=listItems.replace(/[,"\s]{1,}/g,","),listItems.split(",")||[]):[]},updateListItems:function(){this.saveState(),this.getListItems().length>0?this.fireEvent("listitemsupdated",this.getListItems()):this.fireEvent("listitemsupdated",[])},clearListItems:function(){this._getListBox().setValue(null),this.updateListItems()}});
                Ext.define("CA.technicalservices.userutilities.FieldPicker",{alias:"widget.fieldpickerbutton",extend:"Rally.ui.Button",requires:["Rally.ui.popover.Popover","Rally.ui.Button","Rally.ui.picker.FieldPicker","Ext.state.Manager"],toolTipConfig:{html:"Show Columns",anchor:"top"},iconCls:"icon-add-column",cls:"field-picker-btn secondary rly-small",alwaysSelectedValues:["UserName","DisplayName"],fieldBlackList:[],fieldPickerConfig:{},buttonConfig:{},modelNames:["User"],rankingEnabled:!1,margin:"3 9 0 0",constructor:function(config){this.config=_.merge({},this.config||{},config||{}),this.callParent([config])},initComponent:function(){if(this.models)return this.on("click",this._createPopover,this),void this.callParent(arguments);if(this.context&&this.modelNames&&this.modelNames.length>0)Rally.data.ModelFactory.getModels({types:this.modelNames,context:this.context,success:function(models){console.log("models"),this.models=models},failure:function(failedParam){console.log("failedparam")},scope:this}),this.on("click",this._createPopover,this);else{this.iconCls="icon-none";var msg="Please update the CA.technicalservices.FieldPicker configuration with modelNames and context";this.toolTipConfig={html:'<div style="color:red;">'+msg+"</div>"},this.on("click",function(){Rally.ui.notify.Notifier.showError({message:msg})})}this.callParent(arguments)},getFields:function(){return this._fields||this.alwaysSelectedValues},_getPickerConfig:function(){var pickerConfig;return pickerConfig=_.extend({value:this._fields,fieldBlackList:this.fieldBlackList,alwaysSelectedValues:this.alwaysSelectedValues,context:this.context},this.fieldPickerConfig)},_createPopover:function(btn){var popoverTarget=btn.getEl();this.popover=Ext.create("Rally.ui.popover.Popover",{target:popoverTarget,placement:["bottom","left","top","right"],cls:"field-picker-popover",toFront:Ext.emptyFn,buttonAlign:"center",title:this.getTitle(),listeners:{destroy:function(){this.popover=null},scope:this},buttons:[{xtype:"rallybutton",text:"Apply",cls:"field-picker-apply-btn primary rly-small",listeners:{click:function(){this._onApply(this.popover)},scope:this}},{xtype:"rallybutton",text:"Cancel",cls:"field-picker-cancel-btn secondary dark rly-small",listeners:{click:function(){this.popover.close()},scope:this}}],items:[_.extend({xtype:"rallyfieldpicker",cls:"field-picker",itemId:"fieldpicker",modelTypes:this._getModelTypes(),alwaysExpanded:!0,width:200,emptyText:"Search",selectedTextLabel:"Selected",availableTextLabel:"Available",listeners:{specialkey:function(field,e){e.getKey()===e.ESC&&this.popover.close()},scope:this}},this._getPickerConfig())]})},_getModelTypes:function(){return _.pluck(this._getModels(),"typePath")},_getModels:function(){return _.reduce(this.models,function(accum,model){return"artifact"===model.typePath?accum=accum.concat(model.getArtifactComponentModels()):accum.push(model),accum},[])},getTitle:function(){return"Show Columns"},updateFields:function(fields,suspendLoad){this._fields=fields,this.popover&&this.popover.down("rallyfieldpicker")&&this.popover.down("rallyfieldpicker").setValue(fields.join(",")),this.saveState()},getState:function(){return{fields:this._fields}},applyState:function(state){state&&(this._fields=state.fields)},_onApply:function(popover){var fieldPicker=popover.down("rallyfieldpicker"),fields=_.map(fieldPicker.getValue(),function(field){return field.get("name")});this.updateFields(fields),popover.close(),this.fireEvent("fieldsupdated",fields)}});
                Ext.define("CA.technicalservices.userutilities.UserListFilterButton",{extend:"Rally.ui.Button",alias:"widget.listfilterbutton",cls:"secondary rly-small",iconCls:"icon-users",stateful:!0,stateId:"userListFilterButton",stateEvents:["expand","collapse","listupdated"],text:"",config:{context:void 0,modelNames:void 0,toolTipConfig:{anchor:"top",mouseOffset:[-9,-2]}},initComponent:function(){this.callParent(arguments),(!this.stateful||this.stateful&&!this._hasState())&&this.applyState({}),this.on("click",this._togglePanel,this,{buffer:200}),this.on("listitemsupdated",this._onPanelChange,this,{buffer:500}),this.on("collapse",this._onCollapse,this)},_hasState:function(){return!(!this.stateful||!this.stateId)&&!!Ext.state.Manager.get(this.stateId)},_onPanelChange:function(){Ext.suspendLayouts(),this.getItems()&&this.getItems().length>0?(this.setText(Ext.String.format("{0} List Items",this.getItems().length)),this._indicateActiveFilterPresent()):(this.setText(""),this._indicateNoActiveFilterPresent()),Ext.resumeLayouts(!1),this.fireEvent("listupdated",this.getItems())},hasUsers:function(){return this.getListItems().length>0},getItems:function(){return this.userListPanel&&this.userListPanel.getListItems()||[]},getItemField:function(){return"UserName"},afterRender:function(){this.callParent(arguments),this.toolTip.on("beforeshow",this._onBeforeShowToolTip,this)},getState:function(){if(this.userListPanel){var state=this.userListPanel.getListItems();return state.collapsed=this.userListPanel.getCollapsed(),state}return Ext.state.Manager.get(this.stateId)},applyState:function(state){this._build(state)},onDestroy:function(){_.invoke(_.compact([this.relayedEvents,this.userListPanel]),"destroy"),this.callParent(arguments)},clearAllFilters:function(){this.userListPanel&&this.userListPanel.clear()},_build:function(applyParameters){this.userListPanel||(this.userListPanel=Ext.widget({xtype:"listfilterpanel",context:this.context,collapsed:!0,flex:1}),this.relayedEvents=this.relayEvents(this.userListPanel,["expand","collapse","listitemsupdated","panelresize","parametersupdated"]),this.fireEvent("listready",this.userListPanel)),applyParameters&&this._applyParameters()},_applyParameters:function(){},_indicateActiveFilterPresent:function(){this.hasCls("primary")||(this.addCls("primary"),this.removeCls("secondary"))},_indicateNoActiveFilterPresent:function(){this.hasCls("secondary")||(this.addCls("secondary"),this.removeCls("primary"))},_togglePanel:function(){this.userListPanel&&this.userListPanel.toggleCollapse()},collapse:function(){this.userListPanel&&this.userListPanel.collapse()},_onBeforeShowToolTip:function(){var action=this.userListPanel&&this.userListPanel.collapsed?"Show":"Hide";this.toolTip.update(Ext.String.format("{0} User Filter List",action))},_onCollapse:function(){console.log("_onCollapse validate here?")}});
                Ext.define("CA.technicalservices.userutilities.bulkmenu.AssignPermissions",{alias:"widget.assignpermissionsbulkmenuitem",extend:"Rally.ui.menu.bulk.MenuItem",config:{onBeforeAction:function(){},text:"Assign Permissions...",handler:function(){var dialog=Ext.create("CA.technicalservices.userutilities.dialog.AssignProjectPermissions",{});dialog.on("updated",this.assignPermissions,this)},predicate:function(records){return _.every(records,function(record){return record})},assignPermissions:function(dlg,selectionCache){var successfulRecords=this.records,unsuccessfulRecords=[];console.log("assignPermissions",selectionCache);var promises=[];Ext.Array.each(this.records,function(r){var user=r.get("ObjectID");Ext.Object.each(selectionCache,function(permissionKey,projects){var permission=CA.technicalservices.userutilities.ProjectUtility.getPermission(permissionKey);promises.push(function(){return CA.technicalservices.userutilities.ProjectUtility.assignPermissions(user,permission,projects)})})});var records=this.records;Deft.Chain.sequence(promises).then({success:function(results){var idx=0,errorMessages=[];Ext.Array.each(records,function(user){var success=!1;Ext.Object.each(selectionCache,function(permissionKey,projects){console.log("results",user.get("ObjectID"),permissionKey,results[idx][0]),results[idx]&&results[idx][0].success===!0?success=!0:Ext.Array.contains(errorMessages,results[idx][0].message)||errorMessages.push(results[idx][0].message),idx++}),success?successfulRecords.push(user):unsuccessfulRecords.push(user)}),console.log("unsuccessful",errorMessages,unsuccessfulRecords,successfulRecords),this.onActionComplete(successfulRecords,unsuccessfulRecords),errorMessages.length>0&&(console.log("errormessages",errorMessages),Rally.ui.notify.Notifier.showError({message:errorMessages.join(",")}))},scope:this})}}});
                Ext.define("CA.technicalservices.userutilities.bulkmenu.RemovePermissions",{alias:"widget.removepermissionsbulkmenuitem",extend:"Rally.ui.menu.bulk.MenuItem",config:{onBeforeAction:function(){},text:"Remove Permissions...",handler:function(){var dialog=Ext.create("CA.technicalservices.userutilities.dialog.RemovePermissions",{});dialog.on("updated",this.removePermissions,this)},predicate:function(records){return _.every(records,function(record){return record})},removePermissions:function(dlg,selectionCache){var successfulRecords=this.records,unsuccessfulRecords=[],promises=[];Ext.Array.each(this.records,function(r){var user=r.get("ObjectID");Ext.Object.each(selectionCache,function(permissionKey,projects){var permission="No Access";promises.push(function(){return CA.technicalservices.userutilities.ProjectUtility.assignPermissions(user,permission,projects,!0)})})});var records=this.records;Deft.Chain.sequence(promises).then({success:function(results){var idx=0,errorMessages=[];Ext.Array.each(records,function(user){var success=!1;Ext.Object.each(selectionCache,function(permissionKey,projects){console.log("results",user.get("ObjectID"),permissionKey,results[idx][0]),results[idx]&&results[idx][0].success===!0?success=!0:Ext.Array.contains(errorMessages,results[idx][0].message)||errorMessages.push(results[idx][0].message),idx++}),success?successfulRecords.push(user):unsuccessfulRecords.push(user)}),this.onActionComplete(successfulRecords,unsuccessfulRecords),errorMessages.length>0&&Rally.ui.notify.Notifier.showError({message:errorMessages.join(",")})},scope:this})}}});
                Ext.override(Rally.ui.grid.CheckboxModel,{_recordIsSelectable:function(record){return"user"===record.get("_type")}}),Ext.define("CA.technicalservices.userutilities.UserGrid",{extend:"Rally.ui.grid.Grid",config:{columnCfgs:["UserName","DisplayName"],margin:10,storeConfig:{model:"User",pageSize:200},enableBulkEdit:!0,bulkEditConfig:{items:[{xtype:"assignpermissionsbulkmenuitem"},{xtype:"removepermissionsbulkmenuitem"}]},showPagingToolbar:!0,pagingToolbarCfg:{pageSizes:[200,1e3,1500,2e3]}},constructor:function(config){this.mergeConfig(config),this.callParent(arguments)}});
                Ext.define("CA.technicalservices.userutilities.BulkUserUtilityApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){CA.technicalservices.userutilities.ProjectUtility.initialize().then({success:function(){this._addBoxes(),this._addSelectorComponents(),this.buildGrid()},failure:this.showErrorNotification,scope:this})},_addSelectorComponents:function(){this.getSelectorBox().removeAll();var fp=this.getSelectorBox().add({xtype:"fieldpickerbutton",modelNames:["User"],context:this.getContext(),margin:"10 5 10 5",stateful:!0,stateId:"grid-columns"});fp.on("fieldsupdated",this.updateStoreFields,this),this.getSelectorBox().add({xtype:"rallyinlinefilterbutton",modelNames:["User"],context:this.getContext(),margin:"10 5 10 5",stateful:!0,stateId:"grid-filters-1",listeners:{inlinefilterready:this.addInlineFilterPanel,inlinefilterchange:this.updateGridFilters,scope:this}}),this.getSelectorBox().add({xtype:"listfilterbutton",context:this.getContext(),margin:"10 5 10 5",listeners:{scope:this,listready:this.addListFilterPanel,listupdated:this.updateGridFilters}})},addListFilterPanel:function(panel){this.getListFilterBox().add(panel)},updateStoreFields:function(fields){this.getGrid().reconfigureWithColumns(fields)},updateGridFilters:function(filter){console.log("updateGridFilters",filter),this.getSelectorBox().doLayout(),this.buildGrid()},getFilterListButton:function(){return this.down("listfilterbutton")},getFilters:function(){var items=this.getFilterListButton()&&this.getFilterListButton().getItems(),field=this.getFilterListButton()&&this.getFilterListButton().getItemField(),filters=null;items&&items.length>0&&(filters=_.map(items,function(i){return{property:field,value:i}}),filters=Rally.data.wsapi.Filter.or(filters));var filterButton=this.down("rallyinlinefilterbutton");return filterButton&&filterButton.inlineFilterPanel&&filterButton.getWsapiFilter()&&(console.log("advancedfilters",filterButton.getWsapiFilter(),filterButton.getFilters()),filters=filters?filters.and(filterButton.getWsapiFilter()):filterButton.getWsapiFilter()),filters||[]},addInlineFilterPanel:function(panel){this.getAdvancedFilterBox().add(panel)},buildGrid:function(){this.getGridBox().removeAll();var grid=Ext.create("CA.technicalservices.userutilities.UserGrid",{columnCfgs:this.down("fieldpickerbutton").getFields()||void 0,storeConfig:{filters:this.getFilters(),enablePostGet:!1}});this.getGridBox().add(grid)},_addBoxes:function(){this.removeAll(),this.add({xtype:"container",itemId:"selectorBox",layout:"hbox"}),this.add({xtype:"container",itemId:"advancedFilterBox",flex:1}),this.add({xtype:"container",itemId:"listFilterBox",flex:1}),this.add({xtype:"container",itemId:"gridBox"})},getGrid:function(){return this.down("rallygrid")},getGridBox:function(){return this.down("#gridBox")},getSelectorBox:function(){return this.down("#selectorBox")},getListFilterBox:function(){return this.down("#listFilterBox")},getAdvancedFilterBox:function(){return this.down("#advancedFilterBox")},showErrorNotification:function(msg){Rally.ui.notify.Notifier.showError({message:msg})}});

            Rally.launchApp('CA.technicalservices.userutilities.BulkUserUtilityApp', {
                name:"BulkUserUtilityApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .permission-selected{background-color:#00a9e0;color:#fff;padding:1px 5px 1px 5px;text-align:center;font-size:11px;height:15px;border-color:#00a9e0;border-radius:2px;cursor:pointer}.permission-not-selected{color:#00a9e0;background-color:#fff;padding:0 5px 0 5px;text-align:center;border:solid;border-width:1px;font-size:11px;height:15px;border-radius:2px;cursor:pointer}.team-member-yes{color:#3a874f;cursor:pointer}.team-member-no{color:#888d8e;cursor:pointer}
    </style>
</head>
<body>
</body>
</html>
